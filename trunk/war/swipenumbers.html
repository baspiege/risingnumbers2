<!DOCTYPE HTML>
<!-- Copyright 2014 Brian Spiegel -->
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Swipe Numbers!</title>
<style type="text/css">

.removeAnimation {
  background-color:#0000ff;
  -webkit-animation:reduceSizeToZero 1s;
  animation:reduceSizeToZero 1s;
}

@-webkit-keyframes reduceSizeToZero {
  from {width: 45px; height:45px; line-height: 45px;}
  to {width: 0px; height:0; line-height: 0;}
}

@keyframes reduceSizeToZero {
  from {width: 45px; height:45px; line-height: 45px;}
  to {width: 0px; height:0; line-height: 0;}
}

.unselectAnimation {
  background-color:#0000ff;
  -webkit-animation:unselectBackground 1s;
  animation:unselectBackground 1s;
}

@-webkit-keyframes unselectBackground {
  from {background-color:#00ff00;}
  to {background-color:#0000ff;}
}

@keyframes unselectBackground {
  from {background-color:#00ff00;}
  to {background-color:#0000ff;}
}

/* width, height, and line-height will be same. */
.ball {
  width: 45px;
  height: 45px;
  line-height: 45px;
  border-radius: 50%;
  text-align: center;
  vertical-align: middle;
  font-weight:bold;
  color: #ffffff;
}

.selected {
  background-color:#00ff00;
}

.active {
  background-color:#0000ff;
}

.removed {
  background-color:#ff0000;
}

.column {
  float: left;
}

.goal {
  float: left;
  background-color:#ff0000;
}

</style>
</head>
<body>
<script>

/*
TODO

Make board, determine win
* Swipe randomly 2 to board size randomly...  add number to goal... shift board down
* Goals at the bottom
* Repeat till 0... put number back...

Ideas
* Start at 11. Need 11 11 times. Then 12 twelve times.

*/

function Ball() {
  this.x=0;
  this.y=0;
  this.number=0;
  this.selected=false;
  this.removed=false;
}

// Coordinates for touch movement
function Coordinates(x, y) {
  this.x=x;
  this.y=y;
}

// Constants
var BOARD_COL=7;
var BOARD_ROW=8;
var STARTING_BALL_MAX=10;
var COL_WIDTH=45;

var points=0;
var board=new Array();

var goals=new Array();

var mouseSelecting=false;

///////////////////
// Utilities
///////////////////

function createRandomExclusive(max) {
  return Math.floor(Math.random()*max);
}

function findPos(obj) {
  var left=0;
  var top=0;
  if (obj.offsetParent) {
    do {
      left+=obj.offsetLeft;
      top+=obj.offsetTop;
    } while (obj=obj.offsetParent);
  }
  return new Coordinates(left,top);
}

function removeChildrenFromElement(element) {
  if (element.hasChildNodes()) {
    while (element.childNodes.length>0) {
      element.removeChild(element.firstChild);
    }
  }
}

///////////////////
// Board
///////////////////

function checkGoal(count) {
  for (var i=0;i<goals.length;i++) {
    if(goals[i].number==count) {
      return true;
    }
  }
  return false;
}

function checkSelection() {
  var count=getSelectionCount();

  var goalMade=checkGoal(count);
  
  if (goalMade) {
    points+=count;
    updatePointsDisplay();
    removeBallAnimation();
    removeSelectedFromBoard();
    setTimeout(drawBoard,1000);
  }

  if (!goalMade) {
    undoSelected();
  }
}

function createBoard() {
  board=new Array();
  for (var i=0;i<BOARD_COL;i++) {
    var col=new Array();
    board.push(col);
    for (var j=0;j<BOARD_ROW;j++) {
      var ball=new Ball();
      ball.number=createRandomExclusive(STARTING_BALL_MAX)+1;
      col.push(ball);
      ball.x=i;
      ball.y=j;
    }
  }
}

function createGoals() {
  goals=new Array();
  for (var i=0;i<10;i++) {
    var ball=new Ball();
    ball.number=createRandomExclusive(STARTING_BALL_MAX*3)+1;
    goals.push(ball);
  }
}

function fillInBoard() {
  for (var i=0;i<BOARD_COL;i++) {
    var col=board[i];
    for (var j=0;j<BOARD_ROW;j++) {
      if (!(j in col)) {
        ball=new Ball();
        ball.number=createRandomExclusive(STARTING_BALL_MAX)+1;
        col.push(ball);
        ball.x=i;
        ball.y=j;
      }
    }
  }
}

function getSelectionCount() {
  var count=0;
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    for (var j=0;j<col.length;j++) {
      var ball=col[j];
      if (ball.selected) {
        count+=ball.number;
      }
    }
  }
  return count;
}

function reindexBoard() {
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    for (var j=0;j<col.length;j++) {
      var ball=col[j];
      ball.x=i;
      ball.y=j;
    }
  }
}

function removeSelectedFromBoard() {
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    for (var j=col.length-1;j>-1;j--) {
      var ball=col[j];
      if (ball.selected) {
        ball.selected=false;
        col.splice(j,1);
      }
    }
  }
  reindexBoard();
  //fillInBoard();
}

function undoSelected() {
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    for (var j=0;j<col.length;j++) {
      var ball=col[j];
      if (ball.selected) {
        ball.selected=false;
        undoSelectedBallDisplay(ball);
      }
    }
  }
}

///////////////////
// Draw
///////////////////

function clearBoardDisplay() {
  var boardDisplay=document.getElementById("board");
  removeChildrenFromElement(boardDisplay);
}

function clearGoalsDisplay() {
  var goalsDisplay=document.getElementById("goals");
  removeChildrenFromElement(goalsDisplay);
}

function drawBall(ball) {
  var ballDisplay=document.createElement("div");
  ballDisplay.setAttribute("id", "ball-" + ball.x + '-' + ball.y);
  ballDisplay.setAttribute("boardX", ball.x);
  ballDisplay.setAttribute("boardY", ball.y);

  if (ball.removed) {
    ballDisplay.setAttribute("class", "ball removed");
  } else if (ball.selected) {
    ballDisplay.setAttribute("class", "ball selected");
  } else {
    ballDisplay.setAttribute("class", "ball active");
  }

  ballDisplay.appendChild(document.createTextNode(ball.number));
  ballDisplay.addEventListener('mousemove', mouseMove, false);
  return ballDisplay;
}

function drawBalls() {
  var colWidth= COL_WIDTH + "px"
  var boardDisplay=document.getElementById("board");
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    var colDisplay=document.createElement("div");
    colDisplay.setAttribute("class", "column");
    colDisplay.style["width"] = colWidth;
    boardDisplay.appendChild(colDisplay);
    for (var j=0;j<col.length;j++) {
      colDisplay.appendChild(drawBall(col[j]));
    }
  }
}

function drawBoard() {
    clearBoardDisplay();
    drawBalls();
}

function drawGoal(ball) {
  var ballDisplay=document.createElement("div");
  ballDisplay.setAttribute("id", "goal-" + ball.x + '-' + ball.y);
  ballDisplay.setAttribute("class", "ball goal");
  ballDisplay.appendChild(document.createTextNode(ball.number));
  return ballDisplay;
}

function drawGoals() {
  clearGoalsDisplay();
  var goalDisplay=document.getElementById("goals");
  for (var i=0;i<goals.length;i++) {
    goalDisplay.appendChild(drawGoal(goals[i]));
  }
}

function removeBallAnimation() {
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    for (var j=col.length-1;j>-1;j--) {
      var ball=col[j];
      if (ball.selected) {
        var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
        ballDisplay.setAttribute("class", "ball removeAnimation");
      }
    }
  }
}

function selectBallDisplay(ball) {
  var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
  ballDisplay.setAttribute("class", "ball selected");
}

function undoSelectedBallDisplay(ball) {
  var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
  ballDisplay.setAttribute("class", "ball unselectAnimation");
}

function updatePointsDisplay() {
  document.getElementById("points").innerHTML=points;
}

function debug(text) {
  document.getElementById("debug").innerHTML=text;
}

///////////////////
// Mouse Interaction
///////////////////

function preventDefault(e) {
  e.preventDefault();
}

function mouseDown(e) {
  e.preventDefault();
  mouseSelecting=true;
}

function mouseMove(e) {
  e.preventDefault();
  var boardX=e.target.getAttribute("boardX");
  var boardY=e.target.getAttribute("boardY");

  var col=board[boardX];
  var ball=col[boardY];

  if (mouseSelecting && ball) {
    ball.selected=true;
    selectBallDisplay(ball);
  }
}

function mouseUp(e) {
  e.preventDefault();
  mouseSelecting=false;
  checkSelection();
}

///////////////////
// Touch Interaction
///////////////////

function getBallFromCoordinates(coor) {
  var boardDisplay=document.getElementById("board");
  var boardCoor=findPos(boardDisplay);
  var x=Math.floor( (coor.x-boardCoor.x) / COL_WIDTH);
  var y=Math.floor( (coor.y-boardCoor.y) / COL_WIDTH);
  var col=board[x];
  return col[y];
}

// Get coordinates from a touch event
function getCoordinatesTouchEvent(ev) {
  var x;
  var y;
  if (ev.touches && ev.touches.length) { // Multi touch
    x = ev.touches[0].clientX;
    y = ev.touches[0].clientY;
  } else { // Single touch
    x = ev.clientX;
    y = ev.clientY;
  }
  return new Coordinates(x, y);
}

function touchMove(ev) {
  ev.preventDefault();
  touchSelection(ev);
}

function touchSelection(ev) {
  var coor=getCoordinatesTouchEvent(ev);
  var ball=getBallFromCoordinates(coor);
  if (ball) {
    ball.selected=true;
    selectBallDisplay(ball);
  }
}

function touchStart(ev) {
  touchSelection(ev);
}

function touchEnd(ev) {
  checkSelection();
}

///////////////////
// Set-up
///////////////////

function init() {

  // Touch
  document.addEventListener('touchstart', touchStart, false);
  document.addEventListener('touchmove', touchMove, false);
  document.addEventListener('touchend', touchEnd, false);

  // Mouse
  var board=document.getElementById("board");
  board.addEventListener('mousedown', mouseDown, false);
  board.addEventListener('mouseup', mouseUp, false);
  
  var goals=document.getElementById("goals");
  goals.addEventListener('mousedown', preventDefault, false);

  newGame();
}

function newGame() {
  points=0;
  createBoard();
  createGoals();
  
  updatePointsDisplay();
  drawBoard();
  drawGoals();
}

</script>
<div style="width:320px">
  <div style="float:left">Points: <span id="points">100</span></div>
  <br/>
  <div style="float:left;" id="board" width="320" height="320">
  </div>
  <div style="float:left;" id="goals" width="320">
  </div>
  <div style="float:left;margin-top:30px;">
    <button onclick="newGame();return false;">New Game</button><br/><br/>
  </div>
  <div id="debug"></div>
</div>
<script>
init();
</script>
</body>
</html>