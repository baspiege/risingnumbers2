<!DOCTYPE HTML>
<!-- Copyright 2014 Brian Spiegel -->
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Swipe Numbers!</title>
<style type="text/css">

/* width, height, and line-height will be same. */
.ball {
  width: 45px;
  height: 45px;
  line-height: 45px;
  border-radius: 50%;
  text-align: center;
  vertical-align: middle;
  font-weight:bold;
  color: #ffffff;
}

.selected {
  background-color:#00ff00;
}

.active {
  background-color:#0000ff;
}

.removed {
  background-color:#ff0000;
}

.column {
 float: left;
}

</style>
</head>
<body>
<script>

/*
TODO

swipe... shift down... flash for a second... animation that balls leaving.. new balls shifting down...

when shifting down... splice from array, add new balls... and redraw board...

Make board, determine win...
swipe two randomly...  add number to goal... shift board down
goals at the bottom
repeat till 0... put number back...

Try
* Find direction... switch
* Check board.  Remove numbers that add to goal.  Shift down.  Add new numbers.

Ideas
* Start at 11. Need 11 11 times. Then 12 twelve times.
* Color numbers.  Selection yellow?

*/

function Ball() {
  this.x=0;
  this.y=0;
  this.number=0;
  this.selected=false;
  this.removed=false;
}

// Coordinates for touch movement
function Coordinates(x, y) {
  this.x=x;
  this.y=y;
}

// Constants
var BOARD_COL=7;
var BOARD_ROW=8;
var STARTING_BALL_MAX=10;
var COL_WIDTH=45;

// Game variables
var isGameOver=false;
var isGameWon=false;
var points=0;
var board=new Array();

var mouseSelecting=false;

///////////////////
// Utilities
///////////////////

function createRandomExclusive(max) {
  return Math.floor(Math.random()*max);
}

function findPos(obj) {
  var left=0;
  var top=0;
  if (obj.offsetParent) {
    do {
      left+=obj.offsetLeft;
      top+=obj.offsetTop;
    } while (obj=obj.offsetParent);
  }
  return new Coordinates(left,top);
}

function removeChildrenFromElement(element) {
  if (element.hasChildNodes()) {
    while (element.childNodes.length>0) {
      element.removeChild(element.firstChild);
    }
  }
}

///////////////////
// Board
///////////////////

function createBoard() {
  for (var i=0;i<BOARD_COL;i++) {
    var col=new Array();
    board.push(col);
    for (var j=0;j<BOARD_ROW;j++) {
      var ball=new Ball();
      ball.number=createRandomExclusive(STARTING_BALL_MAX)+1;
      col.push(ball);
      ball.x=i;
      ball.y=j;
    }
  }
}

function detectSelection(coor) {
  for (var i=0;i<board.length;i++) {
    // Cols?
  }  
}

function removeSelected() {
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    for (var j=0;j<col.length;j++) {
      var ball=col[j];
      if (col[j].selected) {
        col[j].removed;
        
        var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
        ballDisplay.setAttribute("class", "ball removed");
      }
    }
  }
}

function checkSelection() {
  var goal=12;
  var count=0;
  
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    for (var j=0;j<col.length;j++) {
      var ball=col[j];
      if (ball.selected) {
        count+=ball.number;
        //ball.selected=false;
        //var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
        //ballDisplay.setAttribute("class", "ball removed");
      }
    }
  }
  
  //debug (count + ' ' + goal);
  if (count==goal) {
    points+=goal;
    updatePointsDisplay();
  }
  
  if (count==goal) {
    for (var i=0;i<board.length;i++) {
      var col=board[i];
      for (var j=col.length-1;j>-1;j--) {
        var ball=col[j];
        if (ball.selected) {

          ball.selected=false;
          col.splice(j,1);

        }
      }
    }
    
    // replace board if needed
    //            ball.number=createRandomExclusive(STARTING_BALL_MAX)+1;
    
    drawBoard();
  }
  
  if (count!=goal) {
    
    for (var i=0;i<board.length;i++) {
      var col=board[i];
      for (var j=0;j<col.length;j++) {
        var ball=col[j];

          ball.selected=false;
       
        
      }
    }
        drawBoard();
  }
}


///////////////////
// Draw
///////////////////

function clearBoard() {
  var boardDisplay=document.getElementById("board");
  removeChildrenFromElement(boardDisplay);
}

function drawBall(ball) {
  var ballDisplay=document.createElement("div");
  ballDisplay.setAttribute("id", "ball-" + ball.x + '-' + ball.y);
  ballDisplay.setAttribute("boardX", ball.x);
  ballDisplay.setAttribute("boardY", ball.y);
      
  if (ball.removed) {
    ballDisplay.setAttribute("class", "ball removed");
  } else if (ball.selected) {
    ballDisplay.setAttribute("class", "ball selected");
  } else {
    ballDisplay.setAttribute("class", "ball active");  
  }
  
  ballDisplay.appendChild(document.createTextNode(ball.number));

  ballDisplay.addEventListener('mousemove', mouseMove, false);
  
  return ballDisplay;
}

function drawBalls() {
  var colWidth= COL_WIDTH + "px"
  var boardDisplay=document.getElementById("board");
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    var colDisplay=document.createElement("div");
    colDisplay.setAttribute("class", "column");
    colDisplay.style["width"] = colWidth;
    boardDisplay.appendChild(colDisplay);
    for (var j=0;j<col.length;j++) {
      colDisplay.appendChild(drawBall(col[j]));
    }
  }
}

function drawBoard() {
    clearBoard();
    drawBalls();
}

function updatePointsDisplay() {
  document.getElementById("points").innerHTML=points;
}

function debug(text) {
  document.getElementById("debug").innerHTML=text;
}

///////////////////
// Mouse Interaction
///////////////////

function mouseDown(e) {
  e.preventDefault();
  mouseSelecting=true;
}

function mouseMove(e) {
  e.preventDefault();
  var boardX=e.target.getAttribute("boardX");
  var boardY=e.target.getAttribute("boardY");

  var col=board[boardX];
  var ball=col[boardY];
  
  if (mouseSelecting && ball && !ball.removed) {
    ball.selected=true;
    
    // Move to separate method...
    var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
    ballDisplay.setAttribute("class", "ball selected");  
  }
}

function mouseUp(e) {
  e.preventDefault();
  mouseSelecting=false;
  checkSelection();
}

///////////////////
// Touch Interaction
///////////////////

function getBallFromCoordinates(coor) {
  var boardDisplay=document.getElementById("board");
  var boardCoor=findPos(boardDisplay);
  var x=Math.floor( (coor.x-boardCoor.x) / COL_WIDTH);
  var y=Math.floor( (coor.y-boardCoor.y) / COL_WIDTH);
  
  //debug ( coor.x + ',' + boardCoor.x + ' ' + coor.y + ',' + boardCoor.y );
  var col=board[x];
  return col[y];
}

// Get coordinates from a touch event
function getCoordinatesTouchEvent(ev) {
  var x;
  var y;
  if (ev.touches && ev.touches.length) { // Multi touch
    x = ev.touches[0].clientX;
    y = ev.touches[0].clientY;
  } else { // Single touch
    x = ev.clientX;
    y = ev.clientY;
  }
  //debug(x + ' ' + y);
  return new Coordinates(x, y);
}

function touchSelection(ev) {
  var coor=getCoordinatesTouchEvent(ev);
  var ball=getBallFromCoordinates(coor);
  if (ball && !ball.removed) {
    ball.selected=true;
    
    // Move to separate method...
    var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
    ballDisplay.setAttribute("class", "ball selected");  
  }
}

function touchMove(ev) {
  ev.preventDefault();
  touchSelection(ev);
}

function touchStart(ev) {
  touchSelection(ev);
}

function touchEnd(ev) {
  //removeSelected();
  checkSelection();
}

///////////////////
// Set-up
///////////////////

function init() {

  // Touch
  document.addEventListener('touchstart', touchStart, false);
  document.addEventListener('touchmove', touchMove, false);
  document.addEventListener('touchend', touchEnd, false);

  // Mouse
  var board=document.getElementById("board");
  board.addEventListener('mousedown', mouseDown, false);
  board.addEventListener('mouseup', mouseUp, false);
  
  newGame();
}

function newGame() {

  // Reset variables
  isGameOver=false;
  isGameWon=false;
  points=0;
  board=new Array();
  //debug('');
  
  createBoard();
  updatePointsDisplay();
  drawBoard();
}


</script>
<div style="width:320px">
  <div style="float:left">Points: <span id="points">100</span></div>
  <br/>
  <div style="float:left;" id="board" width="320" height="320">
  </div>
  <div style="float:left;margin-top:30px;">
    <button onclick="newGame();return false;">New Game</button><br/><br/>
  </div>
  <div id="debug"></div>
</div> 
<script>
init();
</script>
</body>
</html>