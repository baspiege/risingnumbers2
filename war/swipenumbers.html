<!DOCTYPE HTML>
<!-- Copyright 2014 Brian Spiegel -->
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>Swipe Numbers!</title>
<style type="text/css">

/* width, height, and line-height will be same. */
.ball {
  width: 45px;
  height: 45px;
  line-height: 45px;
  border-radius: 50%;
  text-align: center;
  vertical-align: middle;
  font-weight:bold;
  color: #ffffff;
}

.selected {
  background-color:#00ff00;
}

.active {
  background-color:#0000ff;
}

.move {
  background-color:#ff0000;
}

.column {
 float: left;
}

</style>
</head>
<body>
<script>

/*
TODO

Try
* Find direction... switch
* Check board.  Remove numbers that add to goal.  Shift down.  Add new numbers.

Ideas
* Start at 11. Need 11 11 times. Then 12 twelve times.
* Color numbers.  Selection yellow?

*/

function Ball() {
  this.x=0;
  this.y=0;
  this.number=0;
  this.selected=false;
}

// Coordinates for touch movement
function Coordinates(x, y) {
  this.x=x;
  this.y=y;
}

// Constants
var BOARD_COL=7;
var BOARD_ROW=7;
var STARTING_BALL_MAX=10;
var COL_WIDTH=45;

// Game variables
var isGameOver=false;
var isGameWon=false;
var points=0;
var board=new Array();

///////////////////
// Utilities
///////////////////

function createRandomExclusive(max) {
  return Math.floor(Math.random()*max);
}

function findPos(obj) {
  var left=0;
  var top=0;
  if (obj.offsetParent) {
    do {
      left+=obj.offsetLeft;
      top+=obj.offsetTop;
    } while (obj=obj.offsetParent);
  }
  return new Coordinates(left,top);
}

function removeChildrenFromElement(element) {
  if (element.hasChildNodes()) {
    while (element.childNodes.length>0) {
      element.removeChild(element.firstChild);
    }
  }
}

///////////////////
// Board
///////////////////

function createBoard() {
  for (var i=0;i<BOARD_COL;i++) {
    var col=new Array();
    board.push(col);
    for (var j=0;j<BOARD_ROW;j++) {
      var ball=new Ball();
      ball.number=createRandomExclusive(STARTING_BALL_MAX)+1;
      col.push(ball);
      ball.x=i;
      ball.y=j;
    }
  }
}

function detectSelection(coor) {
  for (var i=0;i<board.length;i++) {
    // Cols?
  }  
}

///////////////////
// Draw
///////////////////

function clearBoard() {
  var boardDisplay=document.getElementById("board");
  removeChildrenFromElement(boardDisplay);
}

function drawBall(ball) {
  var ballDisplay=document.createElement("div");
  ballDisplay.setAttribute("id", "ball-" + ball.x + '-' + ball.y);
      
  if (ball.selected) {
    ballDisplay.setAttribute("class", "ball selected");
  } else {
    ballDisplay.setAttribute("class", "ball active");  
  }
  
  ballDisplay.appendChild(document.createTextNode(ball.number));
  return ballDisplay;
}

function drawBalls() {
  var colWidth= COL_WIDTH + "px"
  var boardDisplay=document.getElementById("board");
  for (var i=0;i<board.length;i++) {
    var col=board[i];
    var colDisplay=document.createElement("div");
    colDisplay.setAttribute("class", "column");
    colDisplay.style["width"] = colWidth;
    boardDisplay.appendChild(colDisplay);
    for (var j=0;j<col.length;j++) {
      colDisplay.appendChild(drawBall(col[j]));
    }
  }
}

function drawBoard() {
    clearBoard();
    drawBalls();
}

function updatePointsDisplay() {
  document.getElementById("points").innerHTML=points;
}

function debug(text) {
  document.getElementById("debug").innerHTML=text;
}

///////////////////
// Interaction
///////////////////

function getBallFromCoordinates(coor) {
  var boardDisplay=document.getElementById("board");
  var boardCoor=findPos(boardDisplay);
  var x=Math.floor( (coor.x-boardCoor.x) / COL_WIDTH);
  var y=Math.floor( (coor.y-boardCoor.y) / COL_WIDTH);
  
  debug ( coor.x + ',' + boardCoor.x + ' ' + coor.y + ',' + boardCoor.y );
  var col=board[x];
  return col[y];
}

/* Remove if not used...
function isCloseEnough(coor, ball) {
  if (ball) {
    var dY=coor.y-(ball.y*COL_WIDTH + COL_WIDTH/2);
    var dX=coor.x-(ball.x*COL_WIDTH + COL_WIDTH/2);
    return Math.sqrt((dY*dY)+(dX*dX))<=.40*COL_WIDTH;  
  } else {
    return false;
  }
}
*/

// Get coordinates from a touch event
function getCoordinatesTouchEvent(ev) {
  var x;
  var y;
  if (ev.touches && ev.touches.length) { // Multi touch
    x = ev.touches[0].clientX;
    y = ev.touches[0].clientY;
  } else { // Single touch
    x = ev.clientX;
    y = ev.clientY;
  }
  //debug(x + ' ' + y);
  return new Coordinates(x, y);
}

function touchMove(ev) {
  ev.preventDefault();
  var coor=getCoordinatesTouchEvent(ev);
  var ball=getBallFromCoordinates(coor);
  if (ball) {
    ball.selected=true;
    
    // Move to separate method...
    var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
    ballDisplay.setAttribute("class", "ball move");
  }
}

function touchStart(ev) {
  var coor=getCoordinatesTouchEvent(ev);
  var ball=getBallFromCoordinates(coor);
  if (ball) {
    ball.selected=true;
    
    // Move to separate method...
    var ballDisplay=document.getElementById("ball-" + ball.x + '-' + ball.y);
    ballDisplay.setAttribute("class", "ball selected");  
  }
}

function touchEnd(ev) {
  // Determine swipe
}

function mouseMove (ev) {
  // Determine swipe
}

///////////////////
// Set-up
///////////////////

function init() {
  var board=document.getElementById("board");

  // Set listeners
  //board.addEventListener('mousemove', mouseMove, false);
  board.addEventListener('touchstart', touchStart, false);
  board.addEventListener('touchmove', touchMove, false);
  board.addEventListener('touchend', touchEnd, false);
  
  newGame();
}

function newGame() {

  // Reset variables
  isGameOver=false;
  isGameWon=false;
  points=0;
  board=new Array();
  debug('');
  
  createBoard();
  updatePointsDisplay();
  drawBoard();
}


</script>
<div style="width:320px">
  <div style="float:left">Points: <span id="points">100</span></div>
  <br/>
  <div style="float:left;" id="board" width="320" height="320">
  </div>
  <div style="float:left;margin-top:30px;">
    <button onclick="newGame();return false;">New Game</button><br/><br/>
  </div>
  <div id="debug"></div>
</div> 
<script>
init();
</script>
</body>
</html>